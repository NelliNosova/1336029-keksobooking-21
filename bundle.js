(()=>{"use strict";(()=>{const e=e=>{const t=e.slice();for(let e=t.length-1;e>0;e--){const o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t},t=(e,t)=>Math.round(Math.random()*(t-e)+e);window.util={getShuffle:e,getRandomNumber:t,getRandomIndex:e=>e[t(0,e.length-1)],getRandomLengthArray:o=>{const n=[],r=e(o),d=t(0,o.length);for(let e=0;e<d;e++){const t=r[e];n.push(t)}return n},toggleFormElementsState:(e,t)=>{for(let o of e)o.disabled=t},toggleFormElementsChecked:e=>{for(let t of e)t.checked=!1},checkRemove:e=>{e&&e.remove()},addIdToOffer:e=>(e.forEach(((e,t)=>(e.offer.offerId=t,e.offer.offerId))),e)}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success"),n=e=>{const t=()=>{e.remove()},o=t=>{t.key===window.main.Key.ESCAPE&&e.remove()};document.addEventListener("click",t),document.addEventListener("keydown",o),e||(document.removeEventListener("click",t),document.removeEventListener("keydown",o))};window.messages={showError:o=>{const r=t.cloneNode(!0);r.querySelector(".error__message").textContent=o,n(r),e.insertAdjacentElement("afterbegin",r)},showSuccess:()=>{const t=o.cloneNode(!0);e.insertAdjacentElement("afterbegin",t),n(t)}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking",t="GET",o="POST",n=(e,t,o)=>{e.responseType="json",e.addEventListener("load",(()=>{200===e.status?t(e.response):o("Ошибка сервера "+e.status)})),e.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${e.timeout} мс`)})),e.timeout=1e4};window.backend={load:(o,r)=>{const d=new XMLHttpRequest;n(d,o,r),d.open(t,e+"/data"),d.send()},upload:(t,r,d)=>{const a=new XMLHttpRequest;n(a,r,d),a.open(o,""+e),a.send(t)}}})(),(()=>{const e={palace:1e4,house:5e3,flat:1e3,bungalow:0},t="Опция 100 комнат доступна только не для гостей",o='Опция "не для гостей" доступна только для 100 комнат',n="Количество гостей не может быть больше, чем количество комнат",r=document.querySelector(".map"),d=document.querySelector(".ad-form"),a=d.querySelector("#room_number"),i=d.querySelector("#capacity"),s=d.querySelector("#title"),c=d.querySelector("#type"),l=d.querySelector("#price"),u=d.querySelector("#timein"),m=d.querySelector("#timeout"),p=document.querySelectorAll("select"),w=document.querySelectorAll("fieldset"),y=e=>{const r=e.target,d=parseInt(a.value,10),s=parseInt(i.value,10);a.setCustomValidity(""),i.setCustomValidity(""),100===d&&0!==s?r.setCustomValidity(t):100!==d&&0===s?r.setCustomValidity(o):d<s?r.setCustomValidity(n):r.setCustomValidity(""),r.reportValidity()},f=e=>{u.value=e.target.value,m.value=e.target.value},g=()=>{d.reset(),window.main.deactivatePage(),window.messages.showSuccess()};window.util.toggleFormElementsState(w,!0),window.util.toggleFormElementsState(p,!0),s.addEventListener("change",(()=>{const e=s.value.length;e<30?s.setCustomValidity(`Ещё  ${30-e} симв.`):e>100?s.setCustomValidity(`Удалите лишние ${e-100} симв.`):s.setCustomValidity("")})),a.addEventListener("change",y),i.addEventListener("change",y),u.addEventListener("change",f),m.addEventListener("change",f),c.addEventListener("change",(()=>{const t=c.value;l.min=e[t],l.placeholder=e[t]})),l.addEventListener("change",(()=>{const t=l.value,o=c.value;t<e[o]?l.setCustomValidity(`Минимaльная цена для данного типа ${e[o]} руб.`):t>1e6?l.setCustomValidity("Максимальная цена за ночь 1000000 руб."):l.setCustomValidity(""),l.reportValidity()})),d.addEventListener("submit",(e=>{e.preventDefault(),y({target:a}),d.checkValidity()&&(window.backend.upload(new FormData(d),g,window.messages.showError),window.pin.resetMainAddress())})),window.form={toggle:(e,t)=>{r.classList[e]("map--faded"),d.classList[e]("ad-form--disabled"),window.util.toggleFormElementsState(w,t),window.util.toggleFormElementsState(p,t)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector(".map__filters-container");let n=null;const r=(e,t,o=[2,0,1,1,1,2])=>t[e%100>4&&e%100<20?2:o[e%10<5?e%10:5]],d=e=>{e.hasChildNodes()||(e.style.display="none")},a=(e,t)=>{0===Array.from(e).length&&(t.style.display="none")},i=e=>{e.key===window.main.Key.ESCAPE&&s()},s=()=>{n&&(n.remove(),document.removeEventListener("keydown",i))};window.card={open:c=>{const l=parseInt(c.target.closest("button[data-id]").dataset.id,10);(c=>{n&&n.remove(),document.addEventListener("keydown",i);const l=(e=>{const{author:o,offer:i}=e,{avatar:s}=o,{title:c,address:l,price:u,checkin:m,checkout:p,description:w,type:y,rooms:f,guests:g,features:v,photos:h}=i,_=t.cloneNode(!0);if(i){const e=_.querySelector(".popup__title"),t=_.querySelector(".popup__text--address"),o=_.querySelector(".popup__text--price"),i=_.querySelector(".popup__text--time"),S=_.querySelector(".popup__description"),E=_.querySelector(".popup__features"),q=_.querySelector(".popup__type"),L=_.querySelector(".popup__text--capacity"),k=_.querySelector(".popup__photos"),I=_.querySelector(".popup__avatar");e.textContent=c,t.textContent=l,o.textContent=u+"₽/ночь",i.textContent=`Заезд после ${m}, выезд до ${p}`,S.textContent=w,q.textContent=(e=>{switch(e){case"flat":e="Квартира";break;case"bungalow":e="Бунгало";break;case"house":e="Дом";break;case"palace":e="Дворец"}return e})(y),L.textContent=((e,t)=>{let o="";return o=`${e} ${r(e,["комната","комнаты","комнат"])}\n    для ${t} ${r(t,["гостя","гостей","гостей"])}`,o})(f,g),I.src=s,E.innerHTML="",k.innerHTML="";for(let e=0;e<v.length;e++){const t=document.createElement("li");t.className="popup__feature popup__feature--"+v[e],E.appendChild(t)}for(let e=0;e<h.length;e++){const t=document.createElement("img");t.width=45,t.height=40,t.classList.add("popup__photo"),t.src=h[e],t.alt="Фото объекта",k.appendChild(t)}a(c,e),a(l,t),a(u,o),a(m,i),a(p,i),a(w,q),a(f,L),a(g,L),a(s,I),d(E),d(k),n=_}else _.remove();return _})(c);e.insertBefore(l,o);const u=e.querySelector(".popup__close");u.addEventListener("mousedown",(()=>{s()})),u.addEventListener("keydown",(e=>{e.key===window.main.Key.ENTER&&s()}))})(window.dataWithId.find((e=>e.offer.offerId===l)))},remove:()=>{const e=document.querySelector(".map__card");e&&e.remove()}}})(),(()=>{const e={ENTER:"Enter",ESCAPE:"Escape"},t=document.querySelector(".map__pins"),o=document.querySelector(".map__pin--main"),n=document.querySelector(".ad-form__reset");let r=!1;const d=e=>{window.dataWithId=window.util.addIdToOffer(e),window.pin.render(window.filter.getData(window.dataWithId))},a=()=>{r||(r=!0,window.form.toggle("remove",!1),window.backend.load(d,window.messages.showError),window.pin.getMainAddress(r))},i=()=>{const e=document.querySelector(".map__card"),t=document.querySelector(".ad-form-header__preview img"),o=document.querySelector(".ad-form__photo img"),n=document.querySelectorAll("input[type=checkbox]");r=!1,t.src="img/muffin-grey.svg",window.util.toggleFormElementsChecked(n),window.util.checkRemove(e),window.util.checkRemove(o),window.pin.remove(),window.pin.getMainAddress(r),window.form.toggle("add",!0)};o.addEventListener("mousedown",(e=>{0===e.button&&a()})),o.addEventListener("keydown",(t=>{t.key===e.ENTER&&a()})),t.addEventListener("mousedown",(e=>{0===e.button&&e.target.closest("button[data-id]")&&window.card.open(e)})),t.addEventListener("keydown",(t=>{t.key===e.ENTER&&t.target.closest("button[data-id]")&&window.card.open(t)})),n.addEventListener("click",(()=>{window.pin.resetMainAddress(),i()})),window.main={Key:e,isPageActive:r,activatePage:a,deactivatePage:i}})(),(()=>{const e="any",t={low:{min:0,max:1e4},middle:{min:1e4,max:5e4},high:{min:5e4,max:1/0}},o=document.querySelector(".map__filters-container"),n=o.querySelector("#housing-type"),r=o.querySelector("#housing-price"),d=o.querySelector("#housing-rooms"),a=o.querySelector("#housing-guests"),i=o.querySelector("#housing-features").querySelectorAll('input[name="features"]'),s=o=>r.value===e||o.offer.price<=t[r.value].max&&o.offer.price>=t[r.value].min,c=t=>d.value===e||t.offer.rooms===parseInt(d.value,10),l=t=>a.value===e||t.offer.guests===parseInt(a.value,10),u=e=>{for(let t=0;t<i.length;t++)if(i[t].checked&&!e.offer.features.includes(i[t].value))return!1;return!0},m=t=>{let o=[];for(let d=0;d<t.length;d++)o.length<5&&(r=t[d],n.value===e||r.offer.type===n.value)&&s(t[d])&&c(t[d])&&l(t[d])&&u(t[d])&&o.push(t[d]);var r;return o};o.addEventListener("change",(()=>{const e=m(window.dataWithId);let t;t&&window.clearTimeout(t),t=window.setTimeout((function(){window.card.remove(),window.pin.remove(),window.pin.render(e)}),500)})),window.filter={getData:m}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.querySelector(".map__pin--main"),n=document.querySelector("#address"),r=e=>{const o=t.cloneNode(!0),n=o.querySelector("img");return o.style.left=e.location.x-25+"px",o.style.top=e.location.y-70+"px",n.src=e.author.avatar,n.alt=e.offer.title,o.dataset.id=e.offer.offerId,o},d=e=>{const t=parseInt(o.style.left,10),r=parseInt(o.style.top,10),d=Math.round(t+32.5),a=Math.round(e?r+65+22:r+32.5);n.value=`${d}, ${a}`};d(window.main.isPageActive),window.pin={MAIN_PIN_SIZE:65,MAIN_PIN_TAIL:22,render:t=>{const o=document.createDocumentFragment();for(let e=0;e<t.length&&e<5;e++){const n=r(t[e]);o.appendChild(n)}e.appendChild(o)},remove:()=>{const e=document.querySelectorAll("button[data-id]");return e.forEach((e=>{e.remove()})),e},getMainAddress:d,resetMainAddress:()=>{o.style.left="570px",o.style.top="374px"}}})(),(()=>{const e=window.pin.MAIN_PIN_SIZE/2,t=0-e,o=window.pin.MAIN_PIN_SIZE+window.pin.MAIN_PIN_TAIL,n=130-o,r=630-o,d=document.querySelector(".map__pins"),a=document.querySelector(".map__pin--main");a.addEventListener("mousedown",(o=>{o.preventDefault();let i={x:o.clientX,y:o.clientY};const s=o=>{let s,c;o.preventDefault();let l=i.x-o.clientX,u=i.y-o.clientY;i={x:o.clientX,y:o.clientY},s=a.offsetTop-u,c=a.offsetLeft-l,a.style.top=s<n?n+"px":s>r?r+"px":s+"px",c<t?a.style.left=t+"px":c>d.offsetWidth-e?a.style.left=d.offsetWidth-e+"px":a.style.left=c+"px",window.pin.getMainAddress(window.main.isPageActive)},c=e=>{e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",c);const t=e=>{e.preventDefault(),a.removeEventListener("click",t)};a.addEventListener("click",t)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",c)}))})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form__upload input[type=file]"),n=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__photo"),d=(t,o)=>{const n=t.files[0];if(e.some((function(e){return n.type.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){o.src=e.result})),e.readAsDataURL(n)}};t.addEventListener("change",(()=>{d(t,n)})),o.addEventListener("change",(()=>{r.innerHTML='<img alt="Фото объекта" width="70" height="70">';const e=r.querySelector("img");d(o,e)}))})()})();