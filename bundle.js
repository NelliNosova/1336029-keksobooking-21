(()=>{"use strict";(()=>{const e=e=>{const t=e.slice();for(let e=t.length-1;e>0;e--){const o=Math.floor(Math.random()*(e+1));[t[e],t[o]]=[t[o],t[e]]}return t},t=(e,t)=>Math.round(Math.random()*(t-e)+e);window.util={getShuffle:e,getRandomNumber:t,getRandomIndex:e=>e[t(0,e.length-1)],getRandomLengthArray:o=>{const n=[],r=e(o),a=t(0,o.length);for(let e=0;e<a;e++){const t=r[e];n.push(t)}return n},toggleFormElementsState:(e,t)=>{for(let o of e)o.disabled=t},addIdToOffer:e=>(e.forEach(((e,t)=>(e.offer.offerId=t,e.offer.offerId))),e)}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success"),n=e=>{const t=()=>{e.remove()},o=t=>{"Escape"===t.key&&e.remove()};document.addEventListener("click",t),document.addEventListener("keydown",o),e||(document.removeEventListener("click",t),document.removeEventListener("keydown",o))};window.messages={showErrorMassage:o=>{const r=t.cloneNode(!0);r.querySelector(".error__message").textContent=o,n(r),e.insertAdjacentElement("afterbegin",r)},showSuccessMassage:()=>{const t=o.cloneNode(!0);e.insertAdjacentElement("afterbegin",t),n(t)}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking",t=(e,t,o)=>{e.responseType="json",e.addEventListener("load",(()=>{200===e.status?t(e.response):o("Ошибка сервера "+e.status)})),e.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${e.timeout} мс`)})),e.timeout=1e4};window.backend={load:(o,n)=>{const r=new XMLHttpRequest;t(r,o,n),r.open("GET",e+"/data"),r.send()},upload:(o,n,r)=>{const a=new XMLHttpRequest;t(a,n,r),a.open("POST",""+e),a.send(o)}}})(),(()=>{const e={palace:1e4,house:5e3,flat:1e3,bungalow:0},t="Опция 100 комнат доступна только не для гостей",o='Опция "не для гостей" доступна только для 100 комнат',n="Количество гостей не может быть больше, чем количество комнат",r=document.querySelector(".map"),a=document.querySelector(".ad-form"),d=a.querySelector("#room_number"),s=a.querySelector("#capacity"),i=a.querySelector("#title"),c=a.querySelector("#type"),l=a.querySelector("#price"),u=a.querySelector("#timein"),m=a.querySelector("#timeout"),p=document.querySelectorAll("select"),y=document.querySelectorAll("fieldset"),f=e=>{const r=e.target,a=parseInt(d.value,10),i=parseInt(s.value,10);d.setCustomValidity(""),s.setCustomValidity(""),100===a&&0!==i?r.setCustomValidity(t):100!==a&&0===i?r.setCustomValidity(o):a<i?r.setCustomValidity(n):r.setCustomValidity(""),r.reportValidity()},w=e=>{u.value=e.target.value,m.value=e.target.value},g=()=>{a.reset(),window.main.deactivatePage(),window.messages.showSuccessMassage()};window.util.toggleFormElementsState(y,!0),window.util.toggleFormElementsState(p,!0),i.addEventListener("change",(()=>{const e=i.value.length;e<30?i.setCustomValidity(`Ещё  ${30-e} симв.`):e>100?i.setCustomValidity(`Удалите лишние ${e-100} симв.`):i.setCustomValidity("")})),d.addEventListener("change",f),s.addEventListener("change",f),u.addEventListener("change",w),m.addEventListener("change",w),c.addEventListener("change",(()=>{const t=c.value;l.min=e[t],l.placeholder=e[t]})),l.addEventListener("change",(()=>{const t=l.value,o=c.value;t<e[o]?l.setCustomValidity(`Минимaльная цена для данного типа ${e[o]} руб.`):t>1e6?l.setCustomValidity("Максимальная цена за ночь 1000000 руб."):l.setCustomValidity(""),l.reportValidity()})),a.addEventListener("submit",(e=>{e.preventDefault(),f({target:d}),d.reportValidity()&&window.backend.upload(new FormData(a),g,window.messages.showErrorMassage)})),window.form={toggleForm:(e,t)=>{r.classList[e]("map--faded"),a.classList[e]("ad-form--disabled"),window.util.toggleFormElementsState(y,t),window.util.toggleFormElementsState(p,t)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector(".map__filters-container");let n=null;const r=(e,t,o=[2,0,1,1,1,2])=>t[e%100>4&&e%100<20?2:o[e%10<5?e%10:5]],a=e=>{"Escape"===e.key&&d()},d=()=>{n&&(n.remove(),document.removeEventListener("keydown",a))};window.card={renderCard:s=>{n&&n.remove(),document.addEventListener("keydown",a);const i=(e=>{const{author:o,offer:a}=e,{avatar:d}=o,{title:s,address:i,price:c,checkin:l,checkout:u,description:m,type:p,rooms:y,guests:f,features:w,photos:g}=a,v=t.cloneNode(!0),_=v.querySelector(".popup__title"),h=v.querySelector(".popup__text--address"),S=v.querySelector(".popup__text--price"),q=v.querySelector(".popup__text--time"),E=v.querySelector(".popup__description"),L=v.querySelector(".popup__features"),I=v.querySelector(".popup__type"),C=v.querySelector(".popup__text--capacity"),x=v.querySelector(".popup__photos"),k=v.querySelector(".popup__avatar");_.textContent=s,h.textContent=i,S.textContent=c+"₽/ночь",q.textContent=`Заезд после ${l}, выезд до ${u}`,E.textContent=m,I.textContent=(e=>{switch(e){case"flat":e="Квартира";break;case"bungalow":e="Бунгало";break;case"house":e="Дом";break;case"palace":e="Дворец"}return e})(p),C.textContent=((e,t)=>{let o="";return o=`${e} ${r(e,["комната","комнаты","комнат"])}\n    для ${t} ${r(t,["гостя","гостей","гостей"])}`,o})(y,f),k.src=d,L.innerHTML="",x.innerHTML="";for(let e=0;e<w.length;e++){const t=document.createElement("li");t.className="popup__feature popup__feature--"+w[e],L.appendChild(t)}for(let e=0;e<g.length;e++){const t=document.createElement("img");t.width=45,t.height=40,t.classList.add("popup__photo"),t.src=g[e],t.alt="Фото объекта",x.appendChild(t)}return n=v,v})(s);e.insertBefore(i,o);const c=e.querySelector(".popup__close");c.addEventListener("mousedown",(()=>{d()})),c.addEventListener("keydown",(e=>{"Enter"===e.key&&d()}))},openCard:e=>{const t=parseInt(e.target.closest("button[data-id]").dataset.id,10),o=window.dataWithId.find((e=>e.offer.offerId===t));window.card.renderCard(o)},removeCard:()=>{const e=document.querySelector(".map__card");e&&e.remove()},closeCard:d}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector(".map__pin--main"),o=document.querySelector(".ad-form__reset");let n=!1;const r=e=>{window.dataWithId=window.util.addIdToOffer(e),window.pin.renderPins(window.filter.filterData(window.dataWithId))},a=()=>{n||(n=!0,window.form.toggleForm("remove",!1),window.backend.load(r,window.messages.showErrorMassage),window.pin.getMainPinAddress())},d=e=>{e&&e.remove()},s=()=>{const e=document.querySelector(".map__card"),t=document.querySelector(".ad-form-header__preview img"),o=document.querySelector(".ad-form__photo img");n=!1,d(e),d(t),d(o),window.pin.removePins(),window.pin.getMainPinAddress(),window.form.toggleForm("add",!0)};t.addEventListener("mousedown",(e=>{0===e.button&&a()})),t.addEventListener("keydown",(e=>{"Enter"===e.key&&a()})),e.addEventListener("mousedown",(e=>{0===e.button&&e.target.closest("button[data-id]")&&window.card.openCard(e)})),e.addEventListener("keydown",(e=>{"Enter"===e.key&&e.target.closest("button[data-id]")&&window.card.openCard(e)})),o.addEventListener("click",(()=>{t.style.left="570px",t.style.top="374px",s()})),window.main={isPageActive:n,activatePage:a,deactivatePage:s}})(),(()=>{const e="any",t={low:{min:0,max:1e4},middle:{min:1e4,max:5e4},high:{min:5e4,max:1/0}},o=document.querySelector(".map__filters-container"),n=o.querySelector("#housing-type"),r=o.querySelector("#housing-price"),a=o.querySelector("#housing-rooms"),d=o.querySelector("#housing-guests"),s=o.querySelector("#housing-features").querySelectorAll('input[name="features"]'),i=o=>r.value===e||o.offer.price<=t[r.value].max&&o.offer.price>=t[r.value].min,c=t=>a.value===e||t.offer.rooms===parseInt(a.value,10),l=t=>d.value===e||t.offer.guests===parseInt(d.value,10),u=e=>{for(let t=0;t<s.length;t++)if(s[t].checked&&!e.offer.features.includes(s[t].value))return!1;return!0},m=t=>{let o=[];for(let a=0;a<t.length;a++)o.length<5&&(r=t[a],n.value===e||r.offer.type===n.value)&&i(t[a])&&c(t[a])&&l(t[a])&&u(t[a])&&o.push(t[a]);var r;return o};o.addEventListener("change",(()=>{const e=m(window.dataWithId);window.card.removeCard(),window.pin.removePins(),window.pin.renderPins(e)})),window.filter={filterData:m}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.querySelector(".map__pin--main"),n=document.querySelector("#address"),r=e=>{const o=t.cloneNode(!0),n=o.querySelector("img");return o.style.left=e.location.x-25+"px",o.style.top=e.location.y-70+"px",n.src=e.author.avatar,n.alt=e.offer.title,o.dataset.id=e.offer.offerId,o},a=()=>{const e=parseInt(o.style.left,10),t=parseInt(o.style.top,10),r=Math.round(e+32.5),a=Math.round(window.main.isPageActive?t+32.5:t+65+22);n.value=`${r}, ${a}`};a(),window.pin={MAIN_PIN_SIZE:65,MAIN_PIN_TAIL:22,renderPins:t=>{const o=document.createDocumentFragment();for(let e=0;e<t.length&&e<5;e++){const n=r(t[e]);o.appendChild(n)}e.appendChild(o)},removePins:()=>{const e=document.querySelectorAll("button[data-id]");return e.forEach((e=>{e.remove()})),e},getMainPinAddress:a}})(),(()=>{const e=window.pin.MAIN_PIN_SIZE/2,t=0-e,o=window.pin.MAIN_PIN_SIZE+window.pin.MAIN_PIN_TAIL,n=130-o,r=630-o,a=document.querySelector(".map__pins"),d=document.querySelector(".map__pin--main");d.addEventListener("mousedown",(o=>{o.preventDefault();let s={x:o.clientX,y:o.clientY};const i=o=>{let i,c;o.preventDefault();let l=s.x-o.clientX,u=s.y-o.clientY;s={x:o.clientX,y:o.clientY},i=d.offsetTop-u,c=d.offsetLeft-l,d.style.top=i<n?n+"px":i>r?r+"px":i+"px",c<t?d.style.left=t+"px":c>a.offsetWidth-e?d.style.left=a.offsetWidth-e+"px":d.style.left=c+"px",window.pin.getMainPinAddress()},c=e=>{e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",c);const t=e=>{e.preventDefault(),d.removeEventListener("click",t)};d.addEventListener("click",t)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",c)}))})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form__upload input[type=file]"),n=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__photo"),a=(t,o)=>{const n=t.files[0];if(e.some((function(e){return n.type.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){o.src=e.result})),e.readAsDataURL(n)}};t.addEventListener("change",(()=>{a(t,n)})),o.addEventListener("change",(()=>{r.innerHTML='<img alt="Фото объекта" width="70" height="70">';const e=r.querySelector("img");a(o,e)}))})()})();